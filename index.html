<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• CYLEX ADMIN CHAT PANEL</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        /* ========== ADMIN HEADER ========== */
        .admin-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-title h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .admin-badge {
            background: linear-gradient(45deg, #ff0080, #ff8c00);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .admin-stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 800;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        /* ========== MAIN LAYOUT ========== */
        .admin-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        /* ========== USER LIST SIDEBAR ========== */
        .users-sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .users-header h3 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
        }
        
        /* ========== USER ITEM ========== */
        .user-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .user-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .user-item.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
        }
        
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        
        .user-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .status-offline {
            background: rgba(255, 0, 128, 0.2);
            color: #ff0080;
        }
        
        .user-last-seen {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* ========== CHAT MAIN AREA ========== */
        .chat-main {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selected-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-actions {
            display: flex;
            gap: 10px;
        }
        
        .chat-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .chat-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .btn-danger {
            background: rgba(255, 0, 128, 0.2);
        }
        
        .btn-danger:hover {
            background: rgba(255, 0, 128, 0.3);
            color: #ff0080;
        }
        
        /* ========== MESSAGES AREA ========== */
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            padding: 15px;
            border-radius: 15px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.admin {
            align-self: flex-end;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            border-bottom-right-radius: 5px;
        }
        
        .message.user {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 5px;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .message-sender {
            font-weight: 700;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .message-content {
            line-height: 1.5;
            font-size: 15px;
        }
        
        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            padding: 40px;
        }
        
        .no-chat-selected i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* ========== INPUT AREA ========== */
        .input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }
        
        .message-input:focus {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }
        
        .message-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ========== ADMIN AUTH MODAL ========== */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .auth-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-title h2 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .auth-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .auth-input:focus {
            border-color: #00ff88;
        }
        
        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.3);
        }
        
        /* ========== NOTIFICATION ========== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            color: #000;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 1200px) {
            .admin-container {
                flex-direction: column;
                height: auto;
            }
            
            .users-sidebar {
                width: 100%;
                height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .admin-stats {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stat-box {
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- ADMIN AUTH MODAL -->
    <div id="authModal" class="auth-modal">
        <div class="auth-box">
            <div class="auth-title">
                <h2><i class="fas fa-shield-alt"></i> CYLEX ADMIN PANEL</h2>
                <p>Masuk sebagai Administrator</p>
            </div>
            
            <div id="loginForm">
                <input type="password" id="adminPassword" class="auth-input" 
                       placeholder="Masukkan Password Admin" autocomplete="off">
                <button onclick="adminLogin()" class="auth-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> MASUK
                </button>
            </div>
            
            <div id="registerForm" style="display: none; margin-top: 20px;">
                <input type="password" id="adminNewPassword" class="auth-input" 
                       placeholder="Password Baru" autocomplete="off">
                <input type="password" id="adminConfirmPassword" class="auth-input" 
                       placeholder="Konfirmasi Password" autocomplete="off">
                <button onclick="setupAdmin()" class="auth-btn" style="background: linear-gradient(135deg, #ff0080, #ff8c00);">
                    <i class="fas fa-user-shield"></i> SETUP ADMIN
                </button>
            </div>
            
            <p style="text-align: center; margin-top: 20px; font-size: 12px; opacity: 0.7;">
                <a href="#" onclick="toggleRegister()" style="color: #00ff88; text-decoration: none;">
                    Setup Admin Pertama Kali
                </a>
            </p>
        </div>
    </div>

    <!-- MAIN ADMIN INTERFACE -->
    <div id="adminInterface" style="display: none;">
        <!-- HEADER -->
        <div class="admin-header">
            <div class="admin-title">
                <h1><i class="fas fa-terminal"></i> CYLEX ADMIN CHAT</h1>
                <div class="admin-badge">
                    <i class="fas fa-crown"></i> SUPER ADMIN
                </div>
            </div>
            
            <div class="admin-stats">
                <div class="stat-box">
                    <div class="stat-number" id="onlineCount">0</div>
                    <div class="stat-label">ONLINE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">TOTAL USER</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">PESAN</div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTAINER -->
        <div class="admin-container">
            <!-- USER LIST SIDEBAR -->
            <div class="users-sidebar">
                <div class="users-header">
                    <h3><i class="fas fa-users"></i> DAFTAR USER</h3>
                    <div class="chat-btn" onclick="refreshUsers()">
                        <i class="fas fa-sync-alt"></i> REFRESH
                    </div>
                </div>
                
                <div class="users-list" id="usersList">
                    <!-- User list will be populated here -->
                </div>
            </div>

            <!-- CHAT MAIN AREA -->
            <div class="chat-main">
                <!-- SELECTED USER HEADER -->
                <div class="chat-header">
                    <div class="selected-user-info" id="selectedUserInfo">
                        <div class="no-chat-selected">
                            <i class="fas fa-comments"></i>
                            <h3>Pilih user untuk memulai chat</h3>
                            <p>Klik salah satu user di sidebar untuk melihat percakapan</p>
                        </div>
                    </div>
                    
                    <div class="chat-actions" id="chatActions" style="display: none;">
                        <button class="chat-btn" onclick="clearChatWithUser()">
                            <i class="fas fa-trash"></i> HAPUS CHAT
                        </button>
                        <button class="chat-btn btn-danger" onclick="banUser()">
                            <i class="fas fa-ban"></i> BAN USER
                        </button>
                    </div>
                </div>

                <!-- MESSAGES AREA -->
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will appear here -->
                </div>

                <!-- INPUT AREA -->
                <div class="input-area">
                    <textarea class="message-input" id="messageInput" 
                              placeholder="Ketik pesan untuk user..." 
                              rows="1"
                              oninput="autoResize(this)"
                              onkeypress="handleEnter(event)"
                              disabled></textarea>
                    <button class="send-btn" onclick="sendAdminMessage()" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCf230zCliSZ9EYLByMnmflqw8sOz328Uc",
            authDomain: "database-cupz.firebaseapp.com",
            projectId: "database-cupz",
            storageBucket: "database-cupz.firebasestorage.app",
            messagingSenderId: "343357519412",
            appId: "1:343357519412:web:dce862636c7c459e6a3c61"
        };

        // Initialize Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("‚úÖ Firebase initialized successfully");
            }
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // ========== GLOBAL VARIABLES ==========
        let currentAdmin = null;
        let selectedUserId = null;
        let userMessagesListener = null;
        let allUsersListener = null;
        let messagesListener = null;
        
        // ========== ADMIN AUTH FUNCTIONS ==========
        function toggleRegister() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (registerForm.style.display === 'none') {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            } else {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            }
        }
        
        async function checkAdminExists() {
            const adminDoc = await db.collection('admin').doc('credentials').get();
            return adminDoc.exists;
        }
        
        async function setupAdmin() {
            const newPass = document.getElementById('adminNewPassword').value;
            const confirmPass = document.getElementById('adminConfirmPassword').value;
            
            if (!newPass || !confirmPass) {
                showNotification('Password tidak boleh kosong!', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showNotification('Password tidak cocok!', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showNotification('Password minimal 6 karakter!', 'error');
                return;
            }
            
            try {
                // Hash password sederhana (di production harus pakai bcrypt)
                const hashedPass = btoa(newPass);
                
                await db.collection('admin').doc('credentials').set({
                    password: hashedPass,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: null
                });
                
                showNotification('‚úÖ Admin berhasil dibuat! Silakan login.');
                toggleRegister();
                
            } catch (error) {
                console.error('Error setup admin:', error);
                showNotification('Gagal setup admin!', 'error');
            }
        }
        
        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (!password) {
                showNotification('Masukkan password!', 'error');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CHECKING...';
            loginBtn.disabled = true;
            
            try {
                // Check if admin exists
                const adminExists = await checkAdminExists();
                
                if (!adminExists) {
                    showNotification('Admin belum ada. Silakan setup admin pertama!', 'error');
                    toggleRegister();
                    return;
                }
                
                // Get stored password
                const adminDoc = await db.collection('admin').doc('credentials').get();
                const storedPass = adminDoc.data().password;
                
                // Compare password
                const hashedInput = btoa(password);
                
                if (hashedInput === storedPass) {
                    // Login success
                    currentAdmin = {
                        id: 'admin_' + Date.now(),
                        name: 'ADMIN',
                        role: 'super_admin'
                    };
                    
                    // Update last login
                    await db.collection('admin').doc('credentials').update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Show admin interface
                    document.getElementById('authModal').style.display = 'none';
                    document.getElementById('adminInterface').style.display = 'block';
                    
                    showNotification('‚úÖ Login berhasil! Selamat datang Admin!');
                    setupAdminListeners();
                    
                    // Create admin user in users collection
                    await db.collection('chat_users').doc('admin').set({
                        id: 'admin',
                        name: 'ADMIN',
                        isOnline: true,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        role: 'admin'
                    }, { merge: true });
                    
                } else {
                    showNotification('‚ùå Password salah!', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Error saat login!', 'error');
            } finally {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> MASUK';
                loginBtn.disabled = false;
            }
        }
        
        // ========== ADMIN SUPPORT SYSTEM ==========
let adminListener = null;

function listenForAdminMessages() {
    if (adminListener) adminListener();
    
    adminListener = db.collection('chat_messages')
        .where('targetUserId', '==', currentUser.id)
        .where('userId', '==', 'admin')
        .orderBy('timestamp', 'desc')
        .limit(20)
        .onSnapshot((snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const msg = change.doc.data();
                    displayAdminMessage(msg);
                    
                    // Show notification
                    showNotification(`üì© Pesan baru dari ADMIN: ${msg.message.substring(0, 50)}...`);
                }
            });
        });
}

function displayAdminMessage(msg) {
    const chatArea = document.getElementById('chatArea');
    
    const messageElement = document.createElement('div');
    messageElement.className = 'message received admin-message';
    messageElement.style.borderLeft = '4px solid #ff0080';
    messageElement.style.background = 'rgba(255, 0, 128, 0.1)';
    
    const time = msg.timestamp ? 
        new Date(msg.timestamp.toDate()).toLocaleTimeString('id-ID', { 
            hour: '2-digit', 
            minute: '2-digit' 
        }) : 'Just now';
    
    messageElement.innerHTML = `
        <div class="message-header">
            <div class="sender-name" style="color: #ff0080">
                <i class="fas fa-crown"></i> ADMIN
            </div>
            <div class="message-time">${time}</div>
        </div>
        <div class="message-content">
            <strong>Admin:</strong> ${msg.message}
        </div>
    `;
    
    chatArea.appendChild(messageElement);
    
    // Auto scroll
    setTimeout(() => {
        chatArea.scrollTop = chatArea.scrollHeight;
    }, 100);
}

// ========== CONTACT ADMIN BUTTON ==========
function addAdminButton() {
    const inputArea = document.querySelector('.input-area');
    const adminBtn = document.createElement('button');
    adminBtn.className = 'admin-support-btn';
    adminBtn.innerHTML = '<i class="fas fa-headset"></i>';
    adminBtn.title = 'Contact Admin';
    adminBtn.onclick = contactAdmin;
    
    adminBtn.style.cssText = `
        background: linear-gradient(135deg, #ff0080, #ff8c00);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        transition: all 0.3s ease;
    `;
    
    inputArea.insertBefore(adminBtn, inputArea.querySelector('.send-btn'));
}

function contactAdmin() {
    const message = prompt('Ketik pesan untuk admin (optional):');
    
    if (message && message.trim()) {
        // Send message to admin
        db.collection('admin_notifications').add({
            userId: currentUser.id,
            userName: currentUser.name,
            message: message.trim(),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            type: 'user_contact',
            read: false
        });
        
        showNotification('Pesan sudah dikirim ke admin!');
    }
}

// ========== UPDATE showApp FUNCTION ==========
function showApp() {
    // ... existing code ...
    
    // Add admin support features
    addAdminButton();
    listenForAdminMessages();
    
    // Check if user is banned
    checkIfBanned();
}

async function checkIfBanned() {
    const bannedDoc = await db.collection('banned_users').doc(currentUser.id).get();
    
    if (bannedDoc.exists) {
        alert('‚ö†Ô∏è AKUN ANDA DIBANNED!\n\nAnda tidak dapat mengirim pesan lagi.\nHubungi admin untuk informasi lebih lanjut.');
        
        // Disable chat
        document.getElementById('messageInput').disabled = true;
        document.querySelector('.send-btn').disabled = true;
        document.querySelector('.admin-support-btn').style.display = 'none';
    }
}
        
        
        // ========== ADMIN FUNCTIONS ==========
        function setupAdminListeners() {
            listenForUsers();
            listenForAllMessages();
            updateStats();
        }
        
        function listenForUsers() {
            if (allUsersListener) allUsersListener();
            
            allUsersListener = db.collection('chat_users')
                .orderBy('lastSeen', 'desc')
                .onSnapshot((snapshot) => {
                    const users = [];
                    let onlineCount = 0;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        if (user.id !== 'admin') { // Exclude admin from user list
                            users.push(user);
                            if (user.isOnline) onlineCount++;
                        }
                    });
                    
                    displayUsersList(users);
                    document.getElementById('onlineCount').textContent = onlineCount;
                    document.getElementById('totalUsers').textContent = users.length;
                });
        }
        
        function listenForAllMessages() {
            if (messagesListener) messagesListener();
            
            messagesListener = db.collection('chat_messages')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .onSnapshot((snapshot) => {
                    document.getElementById('totalMessages').textContent = snapshot.size;
                });
        }
        
        function displayUsersList(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.5);">
                        <i class="fas fa-user-slash fa-3x" style="margin-bottom: 20px;"></i>
                        <p>Tidak ada user yang aktif</p>
                    </div>
                `;
                return;
            }
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${selectedUserId === user.id ? 'active' : ''}`;
                userElement.onclick = () => selectUser(user);
                
                // Format last seen
                const lastSeen = user.lastSeen ? 
                    new Date(user.lastSeen.toDate()).toLocaleTimeString('id-ID', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Unknown';
                
                userElement.innerHTML = `
                    <div class="user-header">
                        <div class="user-name">
                            <div class="user-avatar" style="background: ${user.avatarColor || '#00ff88'}">
                                ${user.name.charAt(0).toUpperCase()}
                            </div>
                            ${user.name}
                        </div>
                        <div class="user-status ${user.isOnline ? 'status-online' : 'status-offline'}">
                            ${user.isOnline ? 'ONLINE' : 'OFFLINE'}
                        </div>
                    </div>
                    <div class="user-last-seen">
                        <i class="far fa-clock"></i> ${user.isOnline ? 'Active now' : `Last seen: ${lastSeen}`}
                    </div>
                `;
                
                usersList.appendChild(userElement);
            });
        }
        
        function selectUser(user) {
            selectedUserId = user.id;
            
            // Update UI
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.user-item').classList.add('active');
            
            // Show selected user info
            document.getElementById('selectedUserInfo').innerHTML = `
                <div class="user-name" style="font-size: 20px;">
                    <div class="user-avatar" style="width: 48px; height: 48px; font-size: 20px; background: ${user.avatarColor || '#00ff88'}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div>${user.name}</div>
                        <div style="font-size: 14px; opacity: 0.7;">
                            ${user.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                        </div>
                    </div>
                </div>
            `;
            
            // Show chat actions
            document.getElementById('chatActions').style.display = 'flex';
            
            // Enable message input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
            
            // Load messages for this user
            loadUserMessages(user.id);
        }
        
        function loadUserMessages(userId) {
            // Stop previous listener
            if (userMessagesListener) userMessagesListener();
            
            // Clear messages area
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            
            // Listen for messages with this user
            userMessagesListener = db.collection('chat_messages')
                .where('userId', 'in', [userId, 'admin']) // Messages from user OR admin to user
                .orderBy('timestamp', 'asc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    messagesArea.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesArea.innerHTML = `
                            <div class="no-chat-selected" style="padding: 40px;">
                                <i class="fas fa-comment-slash fa-3x"></i>
                                <h3>Belum ada percakapan</h3>
                                <p>Mulai percakapan dengan user ini</p>
                            </div>
                        `;
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        displayMessage(msg, userId);
                    });
                    
                    // Auto scroll to bottom
                    setTimeout(() => {
                        messagesArea.scrollTop = messagesArea.scrollHeight;
                    }, 100);
                });
        }
        
        function displayMessage(msg, selectedUserId) {
            const messagesArea = document.getElementById('messagesArea');
            const isAdminMessage = msg.userId === 'admin' && msg.targetUserId === selectedUserId;
            const isUserMessage = msg.userId === selectedUserId;
            
            if (!isAdminMessage && !isUserMessage) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${msg.userId === 'admin' ? 'admin' : 'user'}`;
            
            // Format time
            const time = msg.timestamp ? 
                new Date(msg.timestamp.toDate()).toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : 'Just now';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">
                        ${msg.userId === 'admin' ? 'ADMIN' : msg.userName}
                    </div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content">${formatMessage(msg.message)}</div>
            `;
            
            messagesArea.appendChild(messageElement);
        }
        
        async function sendAdminMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !selectedUserId) {
                showNotification('Pilih user dan ketik pesan terlebih dahulu!', 'error');
                return;
            }
            
            try {
                // Send message as admin
                await db.collection('chat_messages').add({
                    userId: 'admin',
                    userName: 'ADMIN',
                    targetUserId: selectedUserId, // Target specific user
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isAdminMessage: true
                });
                
                // Create notification for user
                await db.collection('notifications').add({
                    userId: selectedUserId,
                    type: 'admin_message',
                    message: 'Admin mengirim pesan untuk Anda',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });
                
                // Clear input
                messageInput.value = '';
                autoResize(messageInput);
                
                showNotification('‚úÖ Pesan berhasil dikirim ke user!');
                
            } catch (error) {
                console.error('Error sending admin message:', error);
                showNotification('Gagal mengirim pesan!', 'error');
            }
        }
        
        // ========== ADMIN TOOLS ==========
        async function clearChatWithUser() {
            if (!selectedUserId || !confirm('Yakin hapus semua chat dengan user ini?')) {
                return;
            }
            
            try {
                // Get all messages with this user
                const messagesSnapshot = await db.collection('chat_messages')
                    .where('userId', 'in', [selectedUserId, 'admin'])
                    .get();
                
                const batch = db.batch();
                messagesSnapshot.forEach(doc => {
                    const msg = doc.data();
                    // Delete if message is from user OR admin to this user
                    if (msg.userId === selectedUserId || 
                        (msg.userId === 'admin' && msg.targetUserId === selectedUserId)) {
                        batch.delete(doc.ref);
                    }
                });
                
                await batch.commit();
                showNotification('‚úÖ Chat dengan user berhasil dihapus!');
                
            } catch (error) {
                console.error('Error clearing chat:', error);
                showNotification('Gagal menghapus chat!', 'error');
            }
        }
        
        async function banUser() {
            if (!selectedUserId || !confirm('Yakin ban user ini? User tidak bisa chat lagi!')) {
                return;
            }
            
            try {
                await db.collection('banned_users').doc(selectedUserId).set({
                    userId: selectedUserId,
                    bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    bannedBy: 'admin',
                    reason: 'Admin banned'
                });
                
                // Mark user as offline
                await db.collection('chat_users').doc(selectedUserId).update({
                    isOnline: false,
                    status: 'banned'
                });
                
                showNotification('‚úÖ User berhasil dibanned!');
                
            } catch (error) {
                console.error('Error banning user:', error);
                showNotification('Gagal ban user!', 'error');
            }
        }
        
        function refreshUsers() {
            showNotification('Refreshing user list...');
            listenForUsers();
        }
        
        function updateStats() {
            // Update stats periodically
            setInterval(async () => {
                const usersSnapshot = await db.collection('chat_users').get();
                const messagesSnapshot = await db.collection('chat_messages')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                document.getElementById('totalUsers').textContent = usersSnapshot.size - 1; // Exclude admin
                
                let onlineCount = 0;
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.id !== 'admin' && user.isOnline) {
                        onlineCount++;
                    }
                });
                
                document.getElementById('onlineCount').textContent = onlineCount;
                
            }, 30000); // Update every 30 seconds
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function formatMessage(text) {
            // Convert URLs to clickable links
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => 
                `<a href="${url}" target="_blank" style="color: inherit; text-decoration: underline;">${url}</a>`
            );
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        
        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminMessage();
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = type === 'error' ? 
                'linear-gradient(135deg, #ff0080, #ff8c00)' : 
                'linear-gradient(135deg, #00ff88, #00ccff)';
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ========== INITIALIZATION ==========
        async function init() {
            // Check if admin exists on load
            const adminExists = await checkAdminExists();
            
            if (!adminExists) {
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('loginForm').style.display = 'none';
                showNotification('Setup admin pertama kali!');
            }
        }
        
        // Cleanup on exit
        window.addEventListener('beforeunload', async () => {
            if (currentAdmin) {
                await db.collection('chat_users').doc('admin').update({
                    isOnline: false,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
        
        // Initialize
        window.onload = init;
        
        // Export functions
        window.adminLogin = adminLogin;
        window.setupAdmin = setupAdmin;
        window.toggleRegister = toggleRegister;
        window.sendAdminMessage = sendAdminMessage;
        window.clearChatWithUser = clearChatWithUser;
        window.banUser = banUser;
        window.refreshUsers = refreshUsers;
        window.autoResize = autoResize;
        window.handleEnter = handleEnter;
    </script>
</body>
</html>