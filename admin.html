<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WA BADAK - Admin Dashboard</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  
  <!-- Font Awesome & Google Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #25D366;
      --primary-dark: #128C7E;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
    }

    /* Header */
    .admin-header {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo i {
      font-size: 32px;
      color: var(--primary);
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
    }

    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    /* Main Content */
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border-left: 4px solid var(--primary);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .stat-change {
      font-size: 12px;
      color: #10b981;
      font-weight: 600;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #64748b;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .tab:hover:not(.active) {
      background: #f1f5f9;
    }

    /* Tables */
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    table.dataTable {
      width: 100% !important;
      border-collapse: collapse;
    }

    .dataTables_wrapper {
      padding: 20px;
    }

    .dataTables_filter input {
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 8px 12px;
      margin-left: 10px;
    }

    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin: 0 2px;
    }

    .edit-btn {
      background: #3b82f6;
      color: white;
    }

    .edit-btn:hover {
      background: #2563eb;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    .save-btn {
      background: #10b981;
      color: white;
    }

    .save-btn:hover {
      background: #059669;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h2 {
      margin-bottom: 20px;
      color: var(--dark);
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 50px;
      color: #64748b;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f1f5f9;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="admin-header">
    <div class="logo">
      <i class="fab fa-whatsapp"></i>
      <h1>WA BADAK Admin Panel</h1>
    </div>
    
    <div class="user-menu">
      <div class="user-info">
        <div class="user-avatar" id="adminAvatar">A</div>
        <div>
          <div id="adminEmail">admin@wa-badak.com</div>
          <div style="font-size: 12px; color: #64748b;">Administrator</div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-container">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Users</h3>
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-change" id="usersChange">+0 today</div>
      </div>
      
      <div class="stat-card">
        <h3>Active Badak</h3>
        <div class="stat-value" id="activeBadak">0</div>
        <div class="stat-change" id="badakChange">+0 today</div>
      </div>
      
      <div class="stat-card">
        <h3>Total Activities</h3>
        <div class="stat-value" id="totalActivities">0</div>
        <div class="stat-change" id="activitiesChange">+0 today</div>
      </div>
      
      <div class="stat-card">
        <h3>Revenue (IDR)</h3>
        <div class="stat-value" id="totalRevenue">0</div>
        <div class="stat-change" id="revenueChange">+0 today</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="showTab('users')">Users</div>
      <div class="tab" onclick="showTab('badak')">Badak Numbers</div>
      <div class="tab" onclick="showTab('activities')">Activities</div>
      <div class="tab" onclick="showTab('settings')">Settings</div>
    </div>

    <!-- Users Table -->
    <div id="usersTab" class="table-container">
      <div style="padding: 20px;">
        <h2 style="margin-bottom: 20px;">User Management</h2>
        <table id="usersTable" class="display">
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Created</th>
              <th>Total Badak</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Badak Numbers Table -->
    <div id="badakTab" class="table-container" style="display: none;">
      <div style="padding: 20px;">
        <h2 style="margin-bottom: 20px;">Badak Numbers</h2>
        <table id="badakTable" class="display">
          <thead>
            <tr>
              <th>Phone</th>
              <th>User</th>
              <th>Code</th>
              <th>Created</th>
              <th>Expires</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="badakTableBody">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Activities Table -->
    <div id="activitiesTab" class="table-container" style="display: none;">
      <div style="padding: 20px;">
        <h2 style="margin-bottom: 20px;">User Activities</h2>
        <table id="activitiesTable" class="display">
          <thead>
            <tr>
              <th>User</th>
              <th>Type</th>
              <th>Description</th>
              <th>Timestamp</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody id="activitiesTableBody">
            <!-- Data akan diisi oleh JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" style="display: none;">
      <div class="table-container">
        <div style="padding: 20px;">
          <h2 style="margin-bottom: 20px;">System Settings</h2>
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
            <h3 style="margin-bottom: 15px;">Admin Settings</h3>
            <div style="display: grid; gap: 15px; max-width: 400px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Badak Duration (hours)</label>
                <input type="number" id="badakDuration" class="modal-input" value="24">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Auto Cleanup Days</label>
                <input type="number" id="cleanupDays" class="modal-input" value="30">
              </div>
              <button class="save-btn action-btn" onclick="saveSettings()">Save Settings</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2>Edit User</h2>
      <input type="hidden" id="editUserId">
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
        <input type="email" id="editUserEmail" class="modal-input">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">New Password</label>
        <input type="password" id="editUserPassword" class="modal-input" placeholder="Leave empty to keep current">
      </div>
      
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role</label>
        <select id="editUserRole" class="modal-input">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      
      <div class="modal-actions">
        <button class="save-btn action-btn" onclick="saveUserChanges()">Save Changes</button>
        <button class="delete-btn action-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>Loading Admin Dashboard...</div>
  </div>

  <script>
    // Firebase Configuration (SAMA DENGAN SEBELUMNYA)
    const firebaseConfig = {
      apiKey: "AIzaSyCf230zCliSZ9EYLByMnmflqw8sOz328Uc",
      authDomain: "database-cupz.firebaseapp.com",
      projectId: "database-cupz",
      storageBucket: "database-cupz.firebasestorage.app",
      messagingSenderId: "343357519412",
      appId: "1:343357519412:web:dce862636c7c459e6a3c61"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentAdmin = null;
    let usersData = [];
    let activitiesData = [];
    let badakData = [];

    // Check Admin Authentication
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists && userDoc.data().role === 'admin') {
          currentAdmin = user;
          document.getElementById('adminEmail').textContent = user.email;
          document.getElementById('adminAvatar').textContent = user.email.charAt(0).toUpperCase();
          loadDashboard();
        } else {
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });

    async function loadDashboard() {
      document.getElementById('loading').style.display = 'block';
      
      try {
        // Load all data
        await Promise.all([
          loadUsers(),
          loadBadakNumbers(),
          loadActivities(),
          loadStats()
        ]);
        
        // Initialize DataTables
        $('#usersTable').DataTable({
          pageLength: 10,
          order: [[2, 'desc']]
        });
        
        $('#badakTable').DataTable({
          pageLength: 10,
          order: [[3, 'desc']]
        });
        
        $('#activitiesTable').DataTable({
          pageLength: 10,
          order: [[3, 'desc']]
        });
        
        document.getElementById('loading').style.display = 'none';
        
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Error loading dashboard: ' + error.message);
      }
    }

    async function loadUsers() {
      const usersSnapshot = await db.collection('users').get();
      usersData = [];
      
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      
      usersSnapshot.forEach(doc => {
        const user = { id: doc.id, ...doc.data() };
        usersData.push(user);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.email}</td>
          <td><span style="background: ${user.role === 'admin' ? '#10b981' : '#3b82f6'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${user.role}</span></td>
          <td>${user.createdAt ? user.createdAt.toDate().toLocaleDateString('id-ID') : '-'}</td>
          <td>${user.totalBadak || 0}</td>
          <td>
            <button class="edit-btn action-btn" onclick="editUser('${user.id}')">Edit</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('totalUsers').textContent = usersData.length;
    }

    async function loadBadakNumbers() {
      const badakSnapshot = await db.collection('badak_numbers').get();
      badakData = [];
      
      const tbody = document.getElementById('badakTableBody');
      tbody.innerHTML = '';
      
      let activeCount = 0;
      const today = new Date();
      
      badakSnapshot.forEach(doc => {
        const data = { id: doc.id, ...doc.data() };
        badakData.push(data);
        
        const isActive = data.expiredAt && data.expiredAt.toDate() > today;
        if (isActive) activeCount++;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.phone}</td>
          <td>${data.userId}</td>
          <td><code>${data.code}</code></td>
          <td>${data.createdAt ? data.createdAt.toDate().toLocaleDateString('id-ID') : '-'}</td>
          <td>${data.expiredAt ? data.expiredAt.toDate().toLocaleDateString('id-ID') : '-'}</td>
          <td><span style="background: ${isActive ? '#10b981' : '#ef4444'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${isActive ? 'Active' : 'Expired'}</span></td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('activeBadak').textContent = activeCount;
    }

    async function loadActivities() {
      const activitiesSnapshot = await db.collection('activities')
        .orderBy('timestamp', 'desc')
        .limit(100)
        .get();
      
      activitiesData = [];
      const today = new Date().toDateString();
      let todayCount = 0;
      
      const tbody = document.getElementById('activitiesTableBody');
      tbody.innerHTML = '';
      
      activitiesSnapshot.forEach(doc => {
        const activity = { id: doc.id, ...doc.data() };
        activitiesData.push(activity);
        
        if (activity.timestamp && activity.timestamp.toDate().toDateString() === today) {
          todayCount++;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${activity.userEmail}</td>
          <td><span style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${activity.type}</span></td>
          <td>${activity.description}</td>
          <td>${activity.timestamp ? activity.timestamp.toDate().toLocaleString('id-ID') : '-'}</td>
          <td>${activity.ip || '-'}</td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('totalActivities').textContent = activitiesData.length;
      document.getElementById('activitiesChange').textContent = `+${todayCount} today`;
    }

    async function loadStats() {
      // Calculate revenue (contoh: Rp 10.000 per badak)
      const revenue = badakData.length * 10000;
      document.getElementById('totalRevenue').textContent = revenue.toLocaleString('id-ID');
      
      // Calculate users today
      const today = new Date().toDateString();
      const usersToday = usersData.filter(user => 
        user.createdAt && user.createdAt.toDate().toDateString() === today
      ).length;
      document.getElementById('usersChange').textContent = `+${usersToday} today`;
      
      // Calculate badak today
      const badakToday = badakData.filter(data => 
        data.createdAt && data.createdAt.toDate().toDateString() === today
      ).length;
      document.getElementById('badakChange').textContent = `+${badakToday} today`;
      
      // Calculate revenue today
      const revenueToday = badakToday * 10000;
      document.getElementById('revenueChange').textContent = `+Rp ${revenueToday.toLocaleString('id-ID')} today`;
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.table-container').forEach(tab => {
        tab.style.display = 'none';
      });
      document.getElementById('settingsTab').style.display = 'none';
      
      // Show selected tab
      document.getElementById(tabName + 'Tab').style.display = 'block';
      
      // Update active tab
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Refresh DataTables
      setTimeout(() => {
        $('.dataTable').DataTable().columns.adjust().responsive.recalc();
      }, 100);
    }

    function editUser(userId) {
      const user = usersData.find(u => u.id === userId);
      if (!user) return;
      
      document.getElementById('editUserId').value = userId;
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editUserRole').value = user.role || 'user';
      
      document.getElementById('editModal').style.display = 'flex';
    }

    async function saveUserChanges() {
      const userId = document.getElementById('editUserId').value;
      const email = document.getElementById('editUserEmail').value;
      const password = document.getElementById('editUserPassword').value;
      const role = document.getElementById('editUserRole').value;
      
      try {
        // Update email if changed
        if (email !== usersData.find(u => u.id === userId).email) {
          // Note: Changing email requires re-authentication in Firebase
          // For simplicity, we'll just update the Firestore document
          await db.collection('users').doc(userId).update({ email: email });
        }
        
        // Update role
        await db.collection('users').doc(userId).update({ role: role });
        
        // Update password if provided
        if (password) {
          // Note: Admin cannot directly change user password in Firebase
          // This requires Firebase Admin SDK on server side
          alert('Password change requires server-side implementation');
        }
        
        // Log activity
        await db.collection('activities').add({
          adminId: currentAdmin.uid,
          adminEmail: currentAdmin.email,
          type: 'user_update',
          description: `Admin updated user ${userId}`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeModal();
        loadUsers();
        alert('User updated successfully!');
        
      } catch (error) {
        alert('Error updating user: ' + error.message);
      }
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    async function saveSettings() {
      const duration = document.getElementById('badakDuration').value;
      const cleanup = document.getElementById('cleanupDays').value;
      
      // Save to Firestore or localStorage
      localStorage.setItem('badakDuration', duration);
      localStorage.setItem('cleanupDays', cleanup);
      
      alert('Settings saved!');
    }

    async function logout() {
      if (confirm('Yakin ingin logout?')) {
        await auth.signOut();
        window.location.href = 'index.html';
      }
    }

    // Auto refresh data every 30 seconds
    setInterval(() => {
      if (currentAdmin) {
        loadStats();
      }
    }, 30000);
  </script>
</body>
</html>